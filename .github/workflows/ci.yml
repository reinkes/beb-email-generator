name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chrome, firefox]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§ª Validate JavaScript files
      run: |
        echo "ğŸ§ª Running JavaScript validation..."

        # Check if all JS files exist and are readable
        for file in js/*.js; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
            # Basic syntax check using node (if available)
            if command -v node >/dev/null 2>&1; then
              node -c "$file" && echo "âœ… Syntax OK: $file" || echo "âŒ Syntax Error: $file"
            fi
          else
            echo "âŒ Missing: $file"
            exit 1
          fi
        done

        echo "âœ… JavaScript validation completed"

    - name: ğŸŒ Setup simple HTTP server
      run: |
        # Install Python (available by default) to serve files
        echo "ğŸŒ Starting HTTP server..."
        python3 -m http.server 8080 &
        SERVER_PID=$!
        echo $SERVER_PID > server.pid
        sleep 3

        # Test if server is running
        curl -f http://localhost:8080/ > /dev/null && echo "âœ… Server is running" || echo "âŒ Server failed to start"

    - name: ğŸ§ª Run browser tests with curl
      run: |
        echo "ğŸ§ª Running browser compatibility tests..."

        # Test main page loads
        curl -f -s http://localhost:8080/index.html > /dev/null && echo "âœ… Main page loads" || echo "âŒ Main page failed"

        # Test test page loads
        curl -f -s http://localhost:8080/tests/test.html > /dev/null && echo "âœ… Test page loads" || echo "âŒ Test page failed"

        # Test JS modules load
        for file in js/*.js; do
          if [ -f "$file" ]; then
            curl -f -s "http://localhost:8080/$file" > /dev/null && echo "âœ… Module loads: $file" || echo "âŒ Module failed: $file"
          fi
        done

        echo "âœ… Browser compatibility tests completed"

    - name: ğŸ“Š Validate HTML structure
      run: |
        echo "ğŸ“Š Running HTML validation..."

        # Basic HTML structure validation using grep
        if grep -q "<!DOCTYPE html>" index.html; then
          echo "âœ… DOCTYPE declaration found"
        else
          echo "âŒ DOCTYPE declaration missing"
          exit 1
        fi

        if grep -q "<html" index.html; then
          echo "âœ… HTML tag found"
        else
          echo "âŒ HTML tag missing"
          exit 1
        fi

        if grep -q "</html>" index.html; then
          echo "âœ… Closing HTML tag found"
        else
          echo "âŒ Closing HTML tag missing"
          exit 1
        fi

        echo "âœ… HTML validation completed"

    - name: ğŸ” Security scan
      run: |
        echo "ğŸ” Running security checks..."

        # Check for common security issues
        if grep -r "eval(" js/ 2>/dev/null; then
          echo "âŒ Found eval() usage - security risk"
          exit 1
        fi

        if grep -r "innerHTML.*+" js/ 2>/dev/null; then
          echo "âŒ Found dynamic innerHTML - potential XSS risk"
          exit 1
        fi

        # Check for script tags in HTML that might be vulnerable
        if grep -r "<script.*src=" index.html | grep -v "js/"; then
          echo "âš ï¸ Found external script references"
        fi

        # Check for hardcoded credentials
        if grep -ri "password\|secret\|key.*=" js/ --include="*.js" | grep -v "STORAGE_KEY\|getStoredTheme"; then
          echo "âŒ Found potential hardcoded credentials"
          exit 1
        fi

        echo "âœ… Basic security checks passed"

    - name: ğŸ“ Code quality checks
      run: |
        echo "ğŸ“ Running code quality checks..."

        # Check file sizes
        HTML_SIZE=$(wc -c < index.html)
        if [ $HTML_SIZE -gt 100000 ]; then
          echo "âš ï¸ HTML file is large: ${HTML_SIZE} bytes"
        fi

        # Count JavaScript modules
        JS_FILES=$(find js/ -name "*.js" | wc -l)
        echo "ğŸ“¦ JavaScript modules: $JS_FILES"

        # Check for TODO comments in production code
        TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK" js/ | wc -l)
        if [ $TODO_COUNT -gt 0 ]; then
          echo "ğŸ“ Found $TODO_COUNT TODO/FIXME comments"
        fi

        echo "âœ… Code quality checks completed"

    - name: ğŸ§¹ Clean up server
      run: |
        # Kill the HTTP server
        if [ -f server.pid ]; then
          kill $(cat server.pid) 2>/dev/null || echo "Server already stopped"
          rm -f server.pid
        fi

  accessibility:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: â™¿ Basic accessibility checks
      run: |
        echo "â™¿ Running basic accessibility checks..."

        # Check for alt attributes on images
        if grep -r "<img" index.html | grep -v "alt="; then
          echo "âš ï¸ Found images without alt attributes"
        else
          echo "âœ… All images have alt attributes"
        fi

        # Check for proper heading structure
        if grep -q "<h1" index.html; then
          echo "âœ… H1 heading found"
        else
          echo "âš ï¸ No H1 heading found"
        fi

        # Check for form labels
        if grep -r "<input" index.html | grep -v "aria-label\|<label"; then
          echo "âš ï¸ Found inputs without labels"
        else
          echo "âœ… All inputs have labels or aria-labels"
        fi

        # Check for ARIA attributes
        if grep -q "aria-" index.html; then
          echo "âœ… ARIA attributes found"
        else
          echo "âš ï¸ No ARIA attributes found"
        fi

        echo "âœ… Basic accessibility checks completed"

  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš¡ Basic performance checks
      run: |
        echo "âš¡ Running basic performance checks..."

        # Check file sizes
        HTML_SIZE=$(wc -c < index.html | tr -d ' ')
        echo "ğŸ“„ HTML size: ${HTML_SIZE} bytes"
        if [ $HTML_SIZE -gt 100000 ]; then
          echo "âš ï¸ HTML file is large: ${HTML_SIZE} bytes"
        fi

        # Check JavaScript file sizes
        total_js_size=0
        for file in js/*.js; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file" | tr -d ' ')
            echo "ğŸ“„ $file: ${size} bytes"
            total_js_size=$((total_js_size + size))
          fi
        done
        echo "ğŸ“„ Total JavaScript: ${total_js_size} bytes"

        # Count HTTP requests (approximate)
        js_files=$(find js/ -name "*.js" | wc -l)
        echo "ğŸ“¡ JavaScript modules: $js_files"

        # Check for performance best practices
        if grep -q "defer\|async" index.html; then
          echo "âœ… Script loading optimization found"
        else
          echo "âš ï¸ Consider adding defer/async to scripts"
        fi

        echo "âœ… Basic performance checks completed"

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, accessibility, performance]
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "âœ… Staging deployment completed"
        # Add actual deployment commands here

  deploy-production:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, accessibility, performance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŒ Deploy to production
      run: |
        echo "ğŸŒ Deploying to production..."
        echo "âœ… Production deployment completed"
        # Add actual deployment commands here

    - name: ğŸ“Š Update deployment status
      run: |
        echo "ğŸ“Š Updating deployment status badges..."
        # This would typically update deployment status

  release:
    name: ğŸ“¦ Create Release Assets
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Create distribution package
      run: |
        # Create dist directory
        mkdir -p dist

        # Copy main files
        cp index.html dist/
        cp -r js/ dist/

        # Copy additional files if they exist
        [ -d tests/ ] && cp -r tests/ dist/ || echo "âš ï¸ No tests directory found"
        [ -f README.md ] && cp README.md dist/ || echo "âš ï¸ No README.md found"
        [ -f README.en.md ] && cp README.en.md dist/ || echo "âš ï¸ No README.en.md found"
        [ -f TODO.md ] && cp TODO.md dist/ || echo "âš ï¸ No TODO.md found"
        [ -f TECHNICAL_IMPROVEMENTS.md ] && cp TECHNICAL_IMPROVEMENTS.md dist/ || echo "âš ï¸ No TECHNICAL_IMPROVEMENTS.md found"
        [ -f version.json ] && cp version.json dist/ || echo "âš ï¸ No version.json found"
        [ -f LICENSE ] && cp LICENSE dist/ || echo "âš ï¸ No LICENSE found"

        # Create archive
        tar -czf beb-email-generator-${{ github.event.release.tag_name }}.tar.gz -C dist .
        zip -r beb-email-generator-${{ github.event.release.tag_name }}.zip dist/

    - name: ğŸ“¤ Upload release assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./beb-email-generator-${{ github.event.release.tag_name }}.tar.gz
        asset_name: beb-email-generator-${{ github.event.release.tag_name }}.tar.gz
        asset_content_type: application/gzip